name: Sync & Build with Flippy Kernel

on:
  schedule:
    - cron: '0 8 * * 0'     # 每周日早上8点自动运行
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "指定内核版本（例如 6.12.10 或 6.12.y）"
        required: false
        default: "latest"
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-flippy-kernel.yml'
      - 'build-openwrt-huge.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Prepare environment
        run: |
          sudo apt update
          sudo apt install -y curl jq

      - name: Get latest kernel release (6.12.x)
        id: kernel
        run: |
          INPUT_VERSION="${{ github.event.inputs.kernel_version }}"
          if [ "$INPUT_VERSION" = "latest" ] || [ -z "$INPUT_VERSION" ]; then
            KERNEL_JSON=$(curl -s https://api.github.com/repos/ophub/flippy-openwrt-actions/releases/tags/kernel_stable)
            LATEST_KERNEL=$(echo "$KERNEL_JSON" | jq -r '.assets[].name' | grep -E '^6\.12\.' | sort -Vr | head -n 1)
          else
            LATEST_KERNEL="$INPUT_VERSION"
          fi
          echo "kernel_version=$LATEST_KERNEL" >> $GITHUB_OUTPUT
          echo "✅ Using kernel: $LATEST_KERNEL"

      - name: Download Flippy kernel
        run: |
          KERNEL_VERSION=${{ steps.kernel.outputs.kernel_version }}
          echo "Downloading kernel ${KERNEL_VERSION} ..."
          mkdir -p output/kernel
          curl -L -o "output/kernel/${KERNEL_VERSION}.tar.gz" \
            "https://github.com/ophub/flippy-openwrt-actions/releases/download/kernel_stable/${KERNEL_VERSION}.tar.gz"
          echo "✅ Kernel downloaded successfully."

      - name: Commit & push kernel to repo
        env:
          KERNEL_VERSION: ${{ steps.kernel.outputs.kernel_version }}
        run: |
          git pull
          mkdir -p kernel
          cp output/kernel/${KERNEL_VERSION}.tar.gz kernel/
          git add kernel/
          git commit -m "🔄 Update kernel to ${KERNEL_VERSION} from Flippy"
          git push origin main
          echo "✅ Kernel ${KERNEL_VERSION} updated and pushed."

      - name: Trigger build workflow
        uses: peter-evans/workflow-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          workflow: build-openwrt-huge.yml
          ref: main
          inputs: |
            kernel_version=${{ steps.kernel.outputs.kernel_version }}
